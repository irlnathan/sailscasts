
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>sailsCasts</title>
  <meta name="author" content="irl nathan">

  
  <meta name="description" content="Transcript Howdy and welcome to another thought provoking, informative sailscasts answers. Okay, maybe that&rsquo;s a bit of a stretch but welcome &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://irlnathan.github.io/sailscasts">
  <link href="/sailscasts/favicon.png" rel="icon">
  <link href="/sailscasts/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/sailscasts/atom.xml" rel="alternate" title="sailsCasts" type="application/atom+xml">
  <script src="/sailscasts/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/sailscasts/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-43421644-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/sailscasts/">sailsCasts</a></h1>
  
    <h2>Learning about sails.js one screencast at a time.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/sailscasts/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:irlnathan.github.io/sailscasts" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/sailscasts/">Blog</a></li>
  <li><a href="/sailscasts/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/sailscasts/blog/2013/11/20/sailscasts-answers-ep4-creating-a-more-attractive-url-in-sails-with-slugs-dot-dot-dot-really/">sailsCasts Answers: Ep4 - Creating a More Attractive Url in Sails With slugs&#8230;really?</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-11-20T15:08:00-06:00" pubdate data-updated="true">Nov 20<span>th</span>, 2013</time>
        
           | <a href="/sailscasts/blog/2013/11/20/sailscasts-answers-ep4-creating-a-more-attractive-url-in-sails-with-slugs-dot-dot-dot-really/#disqus_thread"
             data-disqus-identifier="http://irlnathan.github.io/sailscasts/blog/2013/11/20/sailscasts-answers-ep4-creating-a-more-attractive-url-in-sails-with-slugs-dot-dot-dot-really/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h1>Transcript</h1>

<p>Howdy and welcome to another thought provoking, informative sailscasts answers.  Okay, maybe that&rsquo;s a bit of a stretch but welcome all the same.  I&rsquo;ve been asked a number of times how to implement a more attractive url system in sails&hellip;commonly using slugs.</p>

<p>Let&rsquo;s take a look at an example. In activityOverlord when you&rsquo;re on the user profile page, the url is something like this <code>http://localhost:1337/user/show/5220fa7b8764043122000001</code>.  The ending part here is a mongoid.  And that id is not very human friendly.  What would be better is to have something like the person&rsquo;s username.  I&rsquo;ll be doing a separate episode incorporating attrative urls into activityOverlord, however, in this screencast I&rsquo;m going to show you how to do it generically for any project.</p>

<p>So I&rsquo;ll create a new project called slugsville by entering <code>sails new slugsville --linker</code> with the linker flag.  Next I&rsquo;ll change into the slugsville folder and generate a user controller and model using <code>sails generate user</code>.  So, let&rsquo;s take a look at the user model.  I&rsquo;m going to paste in attributes for name, company, email, and phone as well as an attribute called slug.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">attributes</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>      <span class="nx">name</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>          <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;string&#39;</span><span class="p">,</span>
</span><span class='line'>          <span class="nx">required</span><span class="o">:</span> <span class="kc">true</span>
</span><span class='line'>      <span class="p">},</span>
</span><span class='line'>
</span><span class='line'>      <span class="nx">slug</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>          <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;string&#39;</span><span class="p">,</span>
</span><span class='line'>      <span class="p">},</span>
</span><span class='line'>
</span><span class='line'>      <span class="nx">email</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>          <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;string&#39;</span><span class="p">,</span>
</span><span class='line'>          <span class="nx">email</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span><span class='line'>          <span class="nx">required</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span><span class='line'>          <span class="nx">unique</span><span class="o">:</span> <span class="kc">true</span>
</span><span class='line'>      <span class="p">},</span>
</span><span class='line'>
</span><span class='line'>      <span class="nx">company</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>          <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;string&#39;</span>
</span><span class='line'>      <span class="p">},</span>
</span><span class='line'>
</span><span class='line'>      <span class="nx">phone</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>          <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;string&#39;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>Let&rsquo;s switch to the user controller. I have a fairly generic create action that creates a user with params I&rsquo;ll send through the  <a href="https://chrome.google.com/webstore/detail/postman-rest-client/fdmmgilgnpjigdojojpjoooidkmcomcm?hl=en">Postman</a> chrome extension and then we&rsquo;ll return a json object.  When the user is created, however, we need to put some logic in that will process the username removing any spaces and lower casing the string before saving the value into the slug model attribute.  We&rsquo;ll do this by adding a <code>beforeCreate()</code> method to our <code>User</code> model.</p>

<p>So going back to the <code>User</code> model, I&rsquo;ll add the <code>beforeCreate()</code> method first chekcing whether <code>name</code> exists and then assigning the <code>slug</code> attribute the value of name with no spaces and all lowercase.  Finally we&rsquo;ll use the next() method to continue.  Let&rsquo;s see if that worked.</p>

<p>I&rsquo;ll go into the terminal and start the sails server using <code>sails lift</code>.  Next, we&rsquo;ll go into the browser and using the postman chrome extension, I&rsquo;ll create a new user with the following attributes.  And great both the user and more importantly the slug were created.</p>

<p>So now let&rsquo;s use this slug as a route parameter.  I&rsquo;ll head over into the `/config/routes.js file located in the config folder where we&rsquo;ll create two routes.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="p">.</span><span class="nx">routes</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="s1">&#39;get /:slug&#39;</span><span class="o">:</span> <span class="s1">&#39;UserController.profile&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="s1">&#39;get /user/:slug&#39;</span><span class="o">:</span> <span class="s1">&#39;UserController.profile&#39;</span><span class="p">,</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// By default, your root route (aka home page) points to a view</span>
</span><span class='line'>  <span class="c1">// located at `views/home/index.ejs`</span>
</span><span class='line'>  <span class="c1">// </span>
</span><span class='line'>  <span class="c1">// (This would also work if you had a file at: `/views/home.ejs`)</span>
</span><span class='line'>  <span class="s1">&#39;/&#39;</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">view</span><span class="o">:</span> <span class="s1">&#39;home/index&#39;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>Both <code>/:slug</code> and <code>/user/:slug</code> will bind themselves to the profile action of the User controller.  In the User controller, I&rsquo;ll create an action called profile. Next I&rsquo;ll grab the slug param and assign it to the var slug.  I want to let anything we catch with the slug param that has a dot in it like <code>image.png</code> to pass through without hitting our find method.  That way we reduce the overhead of searching for a user for params we know are not a name.  So if the param has a dot in it, we&rsquo;ll return next() which will continue to the next piece of middleware (if any).</p>

<p>Next, we&rsquo;ll try to find a user by the slug attribute passing in the slug variable we obtained form the param.  If we don&rsquo;t find a user, we&rsquo;ll again return <code>next()</code>.  If we do have a user I&rsquo;m going to pass the entire user object to the view, in this case <code>profile.ejs</code>.</p>

<p><code>profile.ejs</code> is a simple view template that displays the user name, company, email, and phone.  Finally, I&rsquo;m going to go back to the User controller and add a foo action to make sure that my action blueprint routes still work.  If your not familiar with blueprint routes, I&rsquo;m currently working on episode explaining blueprint routes, the first of which is devoted to action routes.  Here I&rsquo;m just adding the action foo that will return a 200 response.</p>

<p>Okay, let&rsquo;s see if all of this worked?  First, I&rsquo;m going to create a few other users within postman.  Here&rsquo;s a list of our users.  I can still access them via the id using <code>/user/1</code>.  But now I can access them by their username either at <code>/username</code> or <code>/user/username</code>.  I can also access my foo action.</p>

<p>I think that&rsquo;s a much better approach.  I&rsquo;ve left a link to this project&rsquo;s repo here if your interested and I hope that it was helpful and as always thanks for watching.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/sailscasts/blog/2013/11/19/sailscasts-answers-ep3-how-do-i-create-sample-dummy-users-for-my-sails-project/">sailsCasts Answers: Ep3 - How Do I Create Sample &#8216;Dummy&#8217; Users for My Sails Project?</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-11-19T15:02:00-06:00" pubdate data-updated="true">Nov 19<span>th</span>, 2013</time>
        
           | <a href="/sailscasts/blog/2013/11/19/sailscasts-answers-ep3-how-do-i-create-sample-dummy-users-for-my-sails-project/#disqus_thread"
             data-disqus-identifier="http://irlnathan.github.io/sailscasts/blog/2013/11/19/sailscasts-answers-ep3-how-do-i-create-sample-dummy-users-for-my-sails-project/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><iframe width="640" height="390" src="http://www.youtube.com/embed/KYaAf9itjjo" frameborder="0" allowfullscreen></iframe>


<h1>Transcript</h1>

<p>Howdy, I was recently asked whether there was a way to create dummy or fake data for testing  in a sails project.  One way to accomplish this is using <code>/config/bootstrap.js</code>.  Although I can automate the creation of the users, I’ll still need some fake users for sails to create.  Instead of manually typing in each user’s attributes, I found this really handy online tool called <a href="http://www.generatedata.com/">generatedate</a>.  You have a bunch of options of how you want your data generated.  In this example I&rsquo;ll select name, company, and email selecting the simple json format.  I’ll copy all of these users and head over to the <code>bootstrap.js</code> file.</p>

<p>I&rsquo;ll copy our new users into an array called dummyUsers.  Next I&rsquo;ll use the <code>count()</code> method on our <code>user</code> model.  If there are any records in the User model than I&rsquo;ll call the callback and nothing will be altered in the database.  However, if there is no data in the model, I&rsquo;ll use the <code>create()</code> method on the User model, passing in the array <code>dummyUsers</code> and then calling the callback.  Note that the <code>boostrap.js</code> is run once each time sails is started via <code>sails lift</code>.</p>

<p>So, let&rsquo;s see if that worked.  I&rsquo;ll go over to the terminal and enter sails lift.  Next, I&rsquo;ll get a list of user by entering <code>/user</code> into the browser.  And there&rsquo;s our hundred or so users.</p>

<p>I’ve posted a link to the <a href="https://github.com/irlnathan/sails-bootstrap-example">github repo</a> of this project and I hope this was helpful.  Thanks as always for watching.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/sailscasts/blog/2013/11/05/building-a-sails-application-ep26-deploying-a-sails-app-to-heroku/">Building a Sails Application Ep26 - Deploying a Sails App to Heroku.</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-11-05T22:30:00-06:00" pubdate data-updated="true">Nov 5<span>th</span>, 2013</time>
        
           | <a href="/sailscasts/blog/2013/11/05/building-a-sails-application-ep26-deploying-a-sails-app-to-heroku/#disqus_thread"
             data-disqus-identifier="http://irlnathan.github.io/sailscasts/blog/2013/11/05/building-a-sails-application-ep26-deploying-a-sails-app-to-heroku/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><iframe width="640" height="390" src="http://www.youtube.com/embed/ClHsv81XeaE" frameborder="0" allowfullscreen></iframe>


<h1>Transcript</h1>

<p>Howdy and welcome back.  Like most of episodes this one is going to move quickly. I do this so they don’t go on forever, however, I highly recommend stopping and rewatching parts that might go to fast.   So, I thought it would be useful to go over how to deploy activityOverlord into the wild.  This episode will cover deployment to heroku, a self-described cloud application platform.</p>

<p><img class="center" src="/sailscasts/images/ep26/deployment.004.jpg"></p>

<p>Heroku makes it really easy to deploy node apps without a lot of the overhead typically associated with deploymnet.  Although this episode will concentrate on heroku, I plan on covering other platforms in future episodes.</p>

<p>First, let’s look at the current stack of technologies used by activityOverlord.</p>

<p><img class="center" src="/sailscasts/images/ep26/deployment.005.jpg"></p>

<p>I’m running OS X Mountain Lion locally on a MacBook Pro.  I’ve got node installed and sails of course runs on top of that.   Our models, currently the user model,  uses a mongodb database also running locally on mountain lion.  And finally, we store our sessions and sockets in memory.</p>

<p>To do this deployment the stack of technologies is going to change.</p>

<p>For example, instead of running locally on OS X Mountain Lion, node and sails will run on an instance of the hardware and software provided by heroku.  Looking at the heroku docs, node.js runs on instances of <a href="https://devcenter.heroku.com/articles/stack">Ubuntu 10.04</a>.</p>

<p>Next, instead of our current local mongodb database, we’ll create a new instance of the database on a hosted solution provided by mongohq. Finally, we’ll move our in memory socket and session store to redis and specifically redis-to-go hosted by heroku as well.</p>

<p><img class="center" src="/sailscasts/images/ep26/deployment.010.jpg"></p>

<p>Moving from local mongodb to hosted mongohq
So you’ll first need to create an account on mongohq.   Once you have an account and are logged in, create a new hosted mongodb instance using the sandbox option.  Although this option isn’t for production it works for the purposes our project.  Next, I created a user for the database that we’ll use to authenticate in our app.</p>

<p>So I want to incorporate this hosted database in my local instance of activityOverlord before we move it to heroku and we do that by changing the <code>local.js</code> file.  First let’s do a bit of review.</p>

<p><img class="center" src="/sailscasts/images/ep26/deployment.014.jpg"></p>

<p>Our local configuration of mongoDB uses <code>local.js</code> within the config folder while <code>adapters.js</code> is completely commented out at the moment. The <code>adapters.js</code> file is one place sails looks to for connections to databases.  The local.js file overrides anything contained in <code>adapters.js</code>.  Also recall that local.js is part of <code>.gitignore</code> so the file will not be saved to git or our repo.</p>

<p>The impact of this is that anything sails relies upon in terms of configuration in local.js will not be part of the deployment unless we provide for it somewhere else in the code or by using environment variables prior to deployment.</p>

<p>Before we address the deployment issues lets first go into the code and make a few changes to <code>local.js</code> to use our new mongohq instance.</p>

<p>We no longer need the host, user, password, and database attributes because they are combined in a new attribute called url.  I’ll copy and paste the url from the mongohq interface and then insert the username and password I created earlier for the database.</p>

<p>/config/local.js</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">adapters</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>   <span class="s1">&#39;default&#39;</span><span class="o">:</span> <span class="s1">&#39;mongo&#39;</span><span class="p">,</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">mongo</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">module</span>   <span class="o">:</span> <span class="s1">&#39;sails-mongo&#39;</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">url</span><span class="o">:</span> <span class="s2">&quot;mongodb://admin:1234@paulo.mongohq.com:10099/activityoverlord&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">schema</span><span class="o">:</span> <span class="kc">true</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Let’s see if this worked.  I’ll go into the terminal and lift activityoverlord.  Next, I’ll create a new user and great it looks like things are working.  So, I’ll go back into mongohq and into the user collection and there’s my new user.  To start things off, I’ll change my admin attribute to true. Now, I’ll log-in to the account and&hellip;great I have my admin user set-up.</p>

<p>Okay, now, let’s deploy to heroku.  If you don’t already have an account on heroku, go ahead and create one now.  Next, you’ll want to install the heroku toolbelt which can be found <a href="https://toolbelt.heroku.com/">here</a>. Finally, you’ll want to login to heroku from the terminal.  So let’s go to the terminal and type heroku login, this is going to ask us for our  heroku credentials and the first time you run it, it’s also going to set-up your public SSH key.  Don’t worry If you don’t already have one, heroku will walk you through setting one up.</p>

<p>So now that we have an account, got the toolbelt installed, and we’ve logged in from the terminal, we want to back to the heroku dashboard and select create a new app.  If you want to enter in an app name it will need to be something other than activityoverlord as app names must be unique.  If you don’t put in an app name, heroku will create one for you and regardless, you can always go back and rename your app later.</p>

<p>Now you’ll recall that we have a local.js file pointing to the mongodb database hosted on mongohq. Since <code>local.js</code> will not be part of our repo because of <code>.gitignore</code> we need some way of letting the heroku server instance know about the mongodb configuration and we do this with environment variables.  So let’s go back into our <code>adapters.js</code> file and I’m going to copy and paste the mongodb configuration information from our local.js file into this adapters.js file.  However, I’m going to replace where we have a string that contains the Username, password,path, and port of our mongodb instance on mongohq with an environment variable called DB_URL and that’s going to be prefaced by process.env.</p>

<p>/config/adapters.js</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="s1">&#39;default&#39;</span><span class="o">:</span> <span class="s1">&#39;mongo&#39;</span><span class="p">,</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">mongo</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">module</span>   <span class="o">:</span> <span class="s1">&#39;sails-mongo&#39;</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">url</span><span class="o">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">DB_URL</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">schema</span><span class="o">:</span> <span class="kc">true</span>
</span><span class='line'>    <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>So, process.env is a node object that contains our environment which also includes the environment variables that we’ll add to it.  So to add the environment variable to our heroku instance, let’s go back to the terminal and we’ll type <code>heroku config:set DB_URL=</code>  and to get our path I’ll look in our <code>local.js</code> and copy the path of our mongohq instance and paste it here, I’ll also add &mdash;app activitityoverlord1 to point specify which app to associate with.</p>

<p>So we’ve set DB_URL on the remote heroku instance using <code>heroku config:set</code> and used that environment variable in our <code>adapters.js</code> file to point to our mongoHQ instance.</p>

<p>So how is heroku going to start ativityoverlord?  We do that by creating a <code>Procfile</code> in the root of our app.  A Procfile is a mechanism for declaring what commands are run by our app’s dynos on the Heroku platform. More on dynos in a second.  Let’s go back into the code and add a new file named Procfile with no extension.  The file will have one line: <code>web: node app.js</code></p>

<p>Next, make sure you have sails-mongo in your <code>package.json</code> file and that it’s installed in node_modules.  In fact it’s probably best to do an npm install to make sure you have all of the depencies installed.  Now we need to link up the heroku end point with our project.  Let’s go back to the heroku dashboard and look under the settings tab. Go ahead and c opy the git url and then go back to the terminal and enter: <code>git remote add heroku &lt;and then paste the git url here&gt;</code> and press enter.  Add all of your changes to git using: <code>git add .</code> and then commit them using <code>git commit -am “my very descriptive change log”</code>.  Finally push the project by entering: <code>git push heroku master</code>.</p>

<p>The last step before we fire up our browser and look at activityOverlord is to set up a dyno  for our app.  Heroku suggests thinking of a dyno asa virtualized Unix container.  In sum, it’s the place where our app will run.  To assign one dyno to our app, type: <code>heroku ps:scale web=1</code>.</p>

<p>So let’s go back into the browser, refresh the app, and log-in.  Everything looks to be working, however, open up the console and you’ll see an error.  Socket.io is doing its job.  Websockets isn’t working so its failing over to long polling so we still have a connection.  As it turns out, heroku has just started to support web sockets and you must enable it on the application instance.  To do that, we’ll go back to the console and type <code>heroku labs:enable websockets</code>.   It can take a second before websockets starts working.  There we go.  Also, I have had issues with it periodically failing and going back to web polling, but it is in beta so we’ll see how it improves over the coming weeks.</p>

<p>Next, I want to take a look at moving our session and socket store to redis.  But first, why would we want to do this in the first place?  Let’s take the following example.  I have three instances of heroku running activityOverlord on each instance. I use a load balancer to distribute the incoming requests across the three instances.</p>

<p><img class="center" src="/sailscasts/images/ep26/deployment.025.jpg"></p>

<p>Suppose we store sessions in memory, and on the first request the load balancer sends us to instance A where we authenticate and the session cookie is set for that server instance.  On the next request we’re sent to instance B, where we haven’t yet authenticated and therefore won’t be able to access the resources we would have had access on instance A.  Therefore we need some way for the multiple instances of our application to share the same session store.</p>

<p><img class="center" src="/sailscasts/images/ep26/deployment.028.jpg"></p>

<p>This is why we’re moving our session and socket store to redis.</p>

<p>So let’s set-up redis.  We’ll head back to the heroku dashboard and our activityoverlord instance. Select add-ons and redis-to-go. Under Plans, select Nano, or the free plan.  I had to put in a credit card despite picking the free option.  Select add nano for free. Go back to you instance of activityoverlord and select redis-to-go nano under add-ons.</p>

<p>Here you’ll see the configuration path to our redis instance.  First, let’s go into activityoverlord and our <code>session.js</code> file.  As the documentation suggests, I’m going to uncomment, the adapter, host, port, db, and password keys. We can then go back to our redis-to-go configuration file and copy and paste each value into the keys in <code>session.js</code>.</p>

<p>/config/session.js</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">adapter</span><span class="o">:</span> <span class="s1">&#39;redis&#39;</span><span class="p">,</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">host</span><span class="o">:</span> <span class="s1">&#39;soldierfish.redistogo.com&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">port</span><span class="o">:</span> <span class="mi">9599</span><span class="p">,</span>
</span><span class='line'>  <span class="c1">// ttl: &lt;redis session TTL in seconds&gt;,</span>
</span><span class='line'>  <span class="nx">db</span><span class="o">:</span> <span class="s1">&#39;redistogo&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">pass</span><span class="o">:</span> <span class="s1">&#39;d5d68502e87bf36e5d6d25d9c0f37b5a&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Okay, let’s see if this worked.  I’ll go back into the terminal and commit my changes and then push them to our heroku instance.  Now let’s go back to the browser and try to log in.  Even though that worked the true test, is whether our session id is in the redis database.  To determine this, I’m going to use the <code>redis-cli</code> command line tool.  To use this tool we need to again use the host, port and password to authenticate to the database.  Once connected I’ll use the <code>keys</code> command passing in an <code>*</code> as an argument to get all keys.  And there’s our session key, great.  The redis website has good documentation on other useful commands.</p>

<p>You might be asking yourself, I don’t really want to put my redis database credentials in my github repo, and you know you would be right, that would be a very bad idea!  So instead we can use environment variables to set these credentials to our heroku instance.  Let’s go back into <code>session.js</code> and change the values for the host, port, db, and pass keys to environment variables.</p>

<p>/config/session.js</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">adapter</span><span class="o">:</span> <span class="s1">&#39;redis&#39;</span><span class="p">,</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">host</span><span class="o">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">REDIS_HOST</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">port</span><span class="o">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">REDIS_PORT</span><span class="p">,</span>
</span><span class='line'>  <span class="c1">// ttl: &lt;redis session TTL in seconds&gt;,</span>
</span><span class='line'>  <span class="nx">db</span><span class="o">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">REDIS_DB</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">pass</span><span class="o">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">REDIS_PASS</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now the server instance will be looking for those environment variables for the values.  We’ll set them on the heroku instance the same way we did for <code>DB_URL</code> using <code>heroku config:set</code>.</p>

<p>Okay, now let’s do the same for sockets.  We’ll go back to <code>sockets.js</code>.  Similar to <code>session.js</code> we’ll uncomment the host, port, db, and pass keys and then insert the environment variables for the values.</p>

<p>/config/sockets.js</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">adapter</span><span class="o">:</span> <span class="s1">&#39;redis&#39;</span><span class="p">,</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">host</span><span class="o">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">REDIS_HOST</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">port</span><span class="o">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">REDIS_PORT</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">db</span><span class="o">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">REDIS_DB</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">pass</span><span class="o">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">REDIS_PASS</span><span class="p">,</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now, I’m going to go back to the terminal and commit my changes again and push them to our heroku instance.  Now I’ll go back to the browser, notice that I don’t have to login as my session is now maintained by redis whereas before we were doing things in memory which required us to login each time the server was lifted.  I’ll manually log out and log back in. And great it looks like everything is working.</p>

<p>Okay, the last thing I want to address with deployment is changing the value of the <code>NODE_ENV</code> variable from development to production.  For sails one of the biggest outwardly facing changes as a result of using production instead of development is that all of our css files will be combined and minified into one file.  Javascript files will also be combined and minified as well.  In addition many modules utilize <code>NODE_ENV</code> as a hook to determine whether to make changes based upon its value.  We’re going to actually set the environment variable in our <code>Procfile</code>.  So let’s go over to the <code>Procfile</code> and add <code>web: NODE_ENV=production node app.js</code>.  I’ll commit my changes and push them to heroku.  Back in the browser I’ll refresh the page and then look at the source to confirm that all of my css is minified in one file and all of my javascript is minified in one file.</p>

<p>So now that we’ve successfully deployed activityOverlord to Heroku I want to address the work-flow for moving forward with development.  The repo for activityOverlord will have the following set-up for <code>local.js</code>, <code>adapter.js</code>, <code>session.js</code>, and <code>sockets.js</code>.  The <code>local.js</code> file will default to our local instance of mongodb.</p>

<p>/config/local.js</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">port</span><span class="o">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PORT</span> <span class="o">||</span> <span class="mi">1337</span><span class="p">,</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// The runtime &quot;environment&quot; of your Sails app is either &#39;development&#39; or &#39;production&#39;.</span>
</span><span class='line'>  <span class="c1">//</span>
</span><span class='line'>  <span class="c1">// In development, your Sails app will go out of its way to help you</span>
</span><span class='line'>  <span class="c1">// (for instance you will receive more descriptive error and debugging output)</span>
</span><span class='line'>  <span class="c1">//</span>
</span><span class='line'>  <span class="c1">// In production, Sails configures itself (and its dependencies) to optimize performance.</span>
</span><span class='line'>  <span class="c1">// You should always put your app in production mode before you deploy it to a server-</span>
</span><span class='line'>  <span class="c1">// This helps ensure that your Sails app remains stable, performant, and scalable.</span>
</span><span class='line'>  <span class="c1">// </span>
</span><span class='line'>  <span class="c1">// By default, Sails sets its environment using the `NODE_ENV` environment variable.</span>
</span><span class='line'>  <span class="c1">// If NODE_ENV is not set, Sails will run in the &#39;development&#39; environment.</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">environment</span><span class="o">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">NODE_ENV</span> <span class="o">||</span> <span class="s1">&#39;development&#39;</span><span class="p">,</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// LOCAL MONGO DB</span>
</span><span class='line'>  <span class="nx">adapters</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>   <span class="s1">&#39;default&#39;</span><span class="o">:</span> <span class="s1">&#39;mongo&#39;</span><span class="p">,</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">mongo</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">module</span>   <span class="o">:</span> <span class="s1">&#39;sails-mongo&#39;</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">host</span>     <span class="o">:</span> <span class="s1">&#39;localhost&#39;</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">user</span>     <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">password</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">database</span> <span class="o">:</span> <span class="s1">&#39;activityoverlord&#39;</span><span class="p">,</span>
</span><span class='line'>
</span><span class='line'>      <span class="nx">schema</span>   <span class="o">:</span> <span class="kc">true</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// // // HOSTED MONGO HQ</span>
</span><span class='line'>  <span class="c1">// adapters: {</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">//  &#39;default&#39;: &#39;mongo&#39;,</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">//   mongo: {</span>
</span><span class='line'>  <span class="c1">//     module   : &#39;sails-mongo&#39;,</span>
</span><span class='line'>  <span class="c1">//     url: &quot;mongodb://admin:1234@paulo.mongohq.com:10099/activityoverlord&quot;,</span>
</span><span class='line'>  <span class="c1">//     schema: true</span>
</span><span class='line'>  <span class="c1">//   }</span>
</span><span class='line'>  <span class="c1">// }</span>
</span><span class='line'>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>If you want the local version of activityOverlord to use hosted mongohq instance, just uncomment and comment the following lines.  Since <code>local.js</code> will overwrite <code>adapters.js</code> we can leave the existing code in it.</p>

<p>/config/adapters.js</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="p">.</span><span class="nx">adapters</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="s1">&#39;default&#39;</span><span class="o">:</span> <span class="s1">&#39;mongo&#39;</span><span class="p">,</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">mongo</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">module</span>   <span class="o">:</span> <span class="s1">&#39;sails-mongo&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">url</span><span class="o">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">DB_URL</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">schema</span><span class="o">:</span> <span class="kc">true</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>Session.js will use the in memory session store, but when you want to deploy just uncomment these lines and comment your in memory config.</p>

<p>/config/session.js</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="p">.</span><span class="nx">session</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Session secret is automatically generated when your new app is created</span>
</span><span class='line'>  <span class="c1">// Replace at your own risk in production-- you will invalidate the cookies of your users,</span>
</span><span class='line'>  <span class="c1">// forcing them to log in again. </span>
</span><span class='line'>  <span class="nx">secret</span><span class="o">:</span> <span class="s1">&#39;d494d185735d00432bc3485d32bd5ca8&#39;</span><span class="p">,</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// In production, uncomment the following lines to set up a shared redis session store</span>
</span><span class='line'>  <span class="c1">// that can be shared across multiple Sails.js servers</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// HOSTED REDIS INSTANCE</span>
</span><span class='line'>  <span class="nx">adapter</span><span class="o">:</span> <span class="s1">&#39;redis&#39;</span><span class="p">,</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">host</span><span class="o">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">REDIS_HOST</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">port</span><span class="o">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">REDIS_PORT</span><span class="p">,</span>
</span><span class='line'>  <span class="c1">// ttl: &lt;redis session TTL in seconds&gt;,</span>
</span><span class='line'>  <span class="nx">db</span><span class="o">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">REDIS_DB</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">pass</span><span class="o">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">REDIS_PASS</span>
</span><span class='line'>  <span class="c1">// prefix: &#39;sess:&#39;</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// // USE IN MEMORY</span>
</span><span class='line'>  <span class="c1">//   adapter: &#39;memory&#39;</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Uncomment the following lines to use your Mongo adapter as a session store</span>
</span><span class='line'>  <span class="c1">// adapter: &#39;mongo&#39;,</span>
</span><span class='line'>  <span class="c1">//</span>
</span><span class='line'>  <span class="c1">// host: &#39;localhost&#39;,</span>
</span><span class='line'>  <span class="c1">// port: 27017,</span>
</span><span class='line'>  <span class="c1">// db: &#39;sails&#39;,</span>
</span><span class='line'>  <span class="c1">// collection: &#39;sessions&#39;,</span>
</span><span class='line'>  <span class="c1">//</span>
</span><span class='line'>  <span class="c1">// Optional Values:</span>
</span><span class='line'>  <span class="c1">//</span>
</span><span class='line'>  <span class="c1">// # Note: url will override other connection settings</span>
</span><span class='line'>  <span class="c1">// url: &#39;mongodb://user:pass@host:port/database/collection&#39;,</span>
</span><span class='line'>  <span class="c1">//</span>
</span><span class='line'>  <span class="c1">// username: &#39;&#39;,</span>
</span><span class='line'>  <span class="c1">// password: &#39;&#39;,</span>
</span><span class='line'>  <span class="c1">// auto_reconnect: false,</span>
</span><span class='line'>  <span class="c1">// ssl: false,</span>
</span><span class='line'>  <span class="c1">// stringify: true</span>
</span><span class='line'>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>The same holds true for the <code>Sockets.js</code> configuration file.</p>

<p>/config/sockets.js</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
<span class='line-number'>153</span>
<span class='line-number'>154</span>
<span class='line-number'>155</span>
<span class='line-number'>156</span>
<span class='line-number'>157</span>
<span class='line-number'>158</span>
<span class='line-number'>159</span>
<span class='line-number'>160</span>
<span class='line-number'>161</span>
<span class='line-number'>162</span>
<span class='line-number'>163</span>
<span class='line-number'>164</span>
<span class='line-number'>165</span>
<span class='line-number'>166</span>
<span class='line-number'>167</span>
<span class='line-number'>168</span>
<span class='line-number'>169</span>
<span class='line-number'>170</span>
<span class='line-number'>171</span>
<span class='line-number'>172</span>
<span class='line-number'>173</span>
<span class='line-number'>174</span>
<span class='line-number'>175</span>
<span class='line-number'>176</span>
<span class='line-number'>177</span>
<span class='line-number'>178</span>
<span class='line-number'>179</span>
<span class='line-number'>180</span>
<span class='line-number'>181</span>
<span class='line-number'>182</span>
<span class='line-number'>183</span>
<span class='line-number'>184</span>
<span class='line-number'>185</span>
<span class='line-number'>186</span>
<span class='line-number'>187</span>
<span class='line-number'>188</span>
<span class='line-number'>189</span>
<span class='line-number'>190</span>
<span class='line-number'>191</span>
<span class='line-number'>192</span>
<span class='line-number'>193</span>
<span class='line-number'>194</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="cm">/**</span>
</span><span class='line'><span class="cm"> * Socket Configuration</span>
</span><span class='line'><span class="cm"> *</span>
</span><span class='line'><span class="cm"> * These configuration options provide transparent access to Sails&#39; encapsulated</span>
</span><span class='line'><span class="cm"> * pubsub/socket server for complete customizability.</span>
</span><span class='line'><span class="cm"> *</span>
</span><span class='line'><span class="cm"> * For more information on using Sails with Sockets, check out:</span>
</span><span class='line'><span class="cm"> * http://sailsjs.org/#documentation</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'>
</span><span class='line'><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="p">.</span><span class="nx">sockets</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// `transports`</span>
</span><span class='line'>  <span class="c1">//</span>
</span><span class='line'>  <span class="c1">// A array of allowed transport methods which the clients will try to use.</span>
</span><span class='line'>  <span class="c1">// The flashsocket transport is disabled by default</span>
</span><span class='line'>  <span class="c1">// You can enable flashsockets by adding &#39;flashsocket&#39; to this list:</span>
</span><span class='line'>  <span class="nx">transports</span><span class="o">:</span> <span class="p">[</span>
</span><span class='line'>  <span class="s1">&#39;websocket&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="s1">&#39;htmlfile&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="s1">&#39;xhr-polling&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="s1">&#39;jsonp-polling&#39;</span>
</span><span class='line'> <span class="p">],</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Use this option to set the datastore socket.io will use to manage rooms/sockets/subscriptions:</span>
</span><span class='line'>  <span class="c1">// default: memory</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// HOSTED REDIS INSTANCE</span>
</span><span class='line'>  <span class="nx">adapter</span><span class="o">:</span> <span class="s1">&#39;redis&#39;</span><span class="p">,</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">host</span><span class="o">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">REDIS_HOST</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">port</span><span class="o">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">REDIS_PORT</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">db</span><span class="o">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">REDIS_DB</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">pass</span><span class="o">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">REDIS_PASS</span><span class="p">,</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// IN MEMORY</span>
</span><span class='line'>     <span class="c1">// adapter: &#39;memory&#39;,</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Worth mentioning is that, if `adapter` config is `redis`, </span>
</span><span class='line'>  <span class="c1">// but host/port is left unset, Sails will try to connect to redis </span>
</span><span class='line'>  <span class="c1">// running on localhost via port 6379  </span>
</span><span class='line'>  <span class="c1">// `authorization`</span>
</span><span class='line'>  <span class="c1">//</span>
</span><span class='line'>  <span class="c1">// Global authorization for Socket.IO access, </span>
</span><span class='line'>  <span class="c1">// this is called when the initial handshake is performed with the server.</span>
</span><span class='line'>  <span class="c1">// </span>
</span><span class='line'>  <span class="c1">// By default (`authorization: true`), when a socket tries to connect, Sails verifies</span>
</span><span class='line'>  <span class="c1">// that a valid cookie was sent with the upgrade request.  If the cookie doesn&#39;t match</span>
</span><span class='line'>  <span class="c1">// any known user session, a new user session is created for it.</span>
</span><span class='line'>  <span class="c1">//</span>
</span><span class='line'>  <span class="c1">// However, in the case of cross-domain requests, it is possible to receive a connection</span>
</span><span class='line'>  <span class="c1">// upgrade request WITHOUT A COOKIE (for certain transports)</span>
</span><span class='line'>  <span class="c1">// In this case, there is no way to keep track of the requesting user between requests,</span>
</span><span class='line'>  <span class="c1">// since there is no identifying information to link him/her with a session.</span>
</span><span class='line'>  <span class="c1">//</span>
</span><span class='line'>  <span class="c1">// If you don&#39;t care about keeping track of your socket users between requests,</span>
</span><span class='line'>  <span class="c1">// you can bypass this cookie check by setting `authorization: false`</span>
</span><span class='line'>  <span class="c1">// which will disable the session for socket requests (req.session is still accessible </span>
</span><span class='line'>  <span class="c1">// in each request, but it will be empty, and any changes to it will not be persisted)</span>
</span><span class='line'>  <span class="c1">//</span>
</span><span class='line'>  <span class="c1">// On the other hand, if you DO need to keep track of user sessions, </span>
</span><span class='line'>  <span class="c1">// you can pass along a ?cookie query parameter to the upgrade url, </span>
</span><span class='line'>  <span class="c1">// which Sails will use in the absense of a proper cookie</span>
</span><span class='line'>  <span class="c1">// e.g. (when connection from the client):</span>
</span><span class='line'>  <span class="c1">// io.connect(&#39;http://localhost:1337?cookie=smokeybear&#39;)</span>
</span><span class='line'>  <span class="c1">//</span>
</span><span class='line'>  <span class="c1">// (Un)fortunately, the user&#39;s cookie is (should!) not accessible in client-side js.</span>
</span><span class='line'>  <span class="c1">// Using HTTP-only cookies is crucial for your app&#39;s security.</span>
</span><span class='line'>  <span class="c1">// Primarily because of this situation, as well as a handful of other advanced</span>
</span><span class='line'>  <span class="c1">// use cases, Sails allows you to override the authorization behavior </span>
</span><span class='line'>  <span class="c1">// with your own custom logic by specifying a function, e.g:</span>
</span><span class='line'>  <span class="cm">/*</span>
</span><span class='line'><span class="cm">    authorization: function authorizeAttemptedSocketConnection(reqObj, cb) {</span>
</span><span class='line'>
</span><span class='line'><span class="cm">        // Any data saved in `handshake` is available in subsequent requests</span>
</span><span class='line'><span class="cm">        // from this as `req.socket.handshake.*`</span>
</span><span class='line'>
</span><span class='line'><span class="cm">        //</span>
</span><span class='line'><span class="cm">        // to allow the connection, call `cb(null, true)`</span>
</span><span class='line'><span class="cm">        // to prevent the connection, call `cb(null, false)`</span>
</span><span class='line'><span class="cm">        // to report an error, call `cb(err)`</span>
</span><span class='line'><span class="cm">    }</span>
</span><span class='line'><span class="cm">  */</span>
</span><span class='line'>  <span class="nx">authorization</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Match string representing the origins that are allowed to connect to the Socket.IO server</span>
</span><span class='line'>  <span class="nx">origins</span><span class="o">:</span> <span class="s1">&#39;*:*&#39;</span><span class="p">,</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Should we use heartbeats to check the health of Socket.IO connections?</span>
</span><span class='line'>  <span class="nx">heartbeats</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// When client closes connection, the # of seconds to wait before attempting a reconnect.</span>
</span><span class='line'>  <span class="c1">// This value is sent to the client after a successful handshake.</span>
</span><span class='line'>  <span class="s1">&#39;close timeout&#39;</span><span class="o">:</span> <span class="mi">60</span><span class="p">,</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// The # of seconds between heartbeats sent from the client to the server</span>
</span><span class='line'>  <span class="c1">// This value is sent to the client after a successful handshake.</span>
</span><span class='line'>  <span class="s1">&#39;heartbeat timeout&#39;</span><span class="o">:</span> <span class="mi">60</span><span class="p">,</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// The max # of seconds to wait for an expcted heartbeat before declaring the pipe broken</span>
</span><span class='line'>  <span class="c1">// This number should be less than the `heartbeat timeout`</span>
</span><span class='line'>  <span class="s1">&#39;heartbeat interval&#39;</span><span class="o">:</span> <span class="mi">25</span><span class="p">,</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// The maximum duration of one HTTP poll-</span>
</span><span class='line'>  <span class="c1">// if it exceeds this limit it will be closed.</span>
</span><span class='line'>  <span class="s1">&#39;polling duration&#39;</span><span class="o">:</span> <span class="mi">20</span><span class="p">,</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Enable the flash policy server if the flashsocket transport is enabled</span>
</span><span class='line'>  <span class="c1">// &#39;flash policy server&#39;: true,</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// By default the Socket.IO client will check port 10843 on your server </span>
</span><span class='line'>  <span class="c1">// to see if flashsocket connections are allowed.</span>
</span><span class='line'>  <span class="c1">// The Adobe Flash Player normally uses 843 as default port, </span>
</span><span class='line'>  <span class="c1">// but Socket.io defaults to a non root port (10843) by default</span>
</span><span class='line'>  <span class="c1">//</span>
</span><span class='line'>  <span class="c1">// If you are using a hosting provider that doesn&#39;t allow you to start servers</span>
</span><span class='line'>  <span class="c1">// other than on port 80 or the provided port, and you still want to support flashsockets </span>
</span><span class='line'>  <span class="c1">// you can set the `flash policy port` to -1</span>
</span><span class='line'>  <span class="s1">&#39;flash policy port&#39;</span><span class="o">:</span> <span class="mi">10843</span><span class="p">,</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Used by the HTTP transports. The Socket.IO server buffers HTTP request bodies up to this limit. </span>
</span><span class='line'>  <span class="c1">// This limit is not applied to websocket or flashsockets.</span>
</span><span class='line'>  <span class="s1">&#39;destroy buffer size&#39;</span><span class="o">:</span> <span class="s1">&#39;10E7&#39;</span><span class="p">,</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Do we need to destroy non-socket.io upgrade requests?</span>
</span><span class='line'>  <span class="s1">&#39;destroy upgrade&#39;</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Should Sails/Socket.io serve the `socket.io.js` client? </span>
</span><span class='line'>  <span class="c1">// (as well as WebSocketMain.swf for Flash sockets, etc.)</span>
</span><span class='line'>  <span class="s1">&#39;browser client&#39;</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Cache the Socket.IO file generation in the memory of the process</span>
</span><span class='line'>  <span class="c1">// to speed up the serving of the static files.</span>
</span><span class='line'>  <span class="s1">&#39;browser client cache&#39;</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Does Socket.IO need to send a minified build of the static client script?</span>
</span><span class='line'>  <span class="s1">&#39;browser client minification&#39;</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Does Socket.IO need to send an ETag header for the static requests?</span>
</span><span class='line'>  <span class="s1">&#39;browser client etag&#39;</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Adds a Cache-Control: private, x-gzip-ok=&quot;&quot;, max-age=31536000 header to static requests, </span>
</span><span class='line'>  <span class="c1">// but only if the file is requested with a version number like /socket.io/socket.io.v0.9.9.js.</span>
</span><span class='line'>  <span class="s1">&#39;browser client expires&#39;</span><span class="o">:</span> <span class="mi">315360000</span><span class="p">,</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Does Socket.IO need to GZIP the static files?</span>
</span><span class='line'>  <span class="c1">// This process is only done once and the computed output is stored in memory. </span>
</span><span class='line'>  <span class="c1">// So we don&#39;t have to spawn a gzip process for each request.</span>
</span><span class='line'>  <span class="s1">&#39;browser client gzip&#39;</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Optional override function to serve all static files, </span>
</span><span class='line'>  <span class="c1">// including socket.io.js et al.</span>
</span><span class='line'>  <span class="c1">// Of the form :: function (req, res) { /* serve files */ }</span>
</span><span class='line'>  <span class="s1">&#39;browser client handler&#39;</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Meant to be used when running socket.io behind a proxy. </span>
</span><span class='line'>  <span class="c1">// Should be set to true when you want the location handshake to match the protocol of the origin. </span>
</span><span class='line'>  <span class="c1">// This fixes issues with terminating the SSL in front of Node </span>
</span><span class='line'>  <span class="c1">// and forcing location to think it&#39;s wss instead of ws.</span>
</span><span class='line'>  <span class="s1">&#39;match origin protocol&#39;</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Direct access to the socket.io MQ store config</span>
</span><span class='line'>  <span class="c1">// The &#39;adapter&#39; property is the preferred method</span>
</span><span class='line'>  <span class="c1">// (`undefined` indicates that Sails should defer to the &#39;adapter&#39; config)</span>
</span><span class='line'>  <span class="nx">store</span><span class="o">:</span> <span class="kc">undefined</span><span class="p">,</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// A logger instance that is used to output log information.</span>
</span><span class='line'>  <span class="c1">// (`undefined` indicates deferment to the main Sails log config)</span>
</span><span class='line'>  <span class="nx">logger</span><span class="o">:</span> <span class="kc">undefined</span><span class="p">,</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// The amount of detail that the server should output to the logger.</span>
</span><span class='line'>  <span class="c1">// (`undefined` indicates deferment to the main Sails log config)</span>
</span><span class='line'>  <span class="s1">&#39;log level&#39;</span><span class="o">:</span> <span class="kc">undefined</span><span class="p">,</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Whether to color the log type when output to the logger.</span>
</span><span class='line'>  <span class="c1">// (`undefined` indicates deferment to the main Sails log config)</span>
</span><span class='line'>  <span class="s1">&#39;log colors&#39;</span><span class="o">:</span> <span class="kc">undefined</span><span class="p">,</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// A Static instance that is used to serve the socket.io client and its dependencies.</span>
</span><span class='line'>  <span class="c1">// (`undefined` indicates use default)</span>
</span><span class='line'>  <span class="s1">&#39;static&#39;</span><span class="o">:</span> <span class="kc">undefined</span><span class="p">,</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// The entry point where Socket.IO starts looking for incoming connections. </span>
</span><span class='line'>  <span class="c1">// This should be the same between the client and the server.</span>
</span><span class='line'>  <span class="nx">resource</span><span class="o">:</span> <span class="s1">&#39;/socket.io&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p></p>

<p>We’ve covered a bunch of material in this episode.  I hope you found it helpful and as always thanks for watching.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/sailscasts/blog/2013/10/25/building-a-sails-application-ep25-what-is-commonjs-in-relation-to-node-what-does-it-do-how-do-i-use-it/">Building a Sails Application Ep25 - What Is CommonJS in Relation to Node? What Does It Do? How Do I Use It?</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-10-25T17:45:00-05:00" pubdate data-updated="true">Oct 25<span>th</span>, 2013</time>
        
           | <a href="/sailscasts/blog/2013/10/25/building-a-sails-application-ep25-what-is-commonjs-in-relation-to-node-what-does-it-do-how-do-i-use-it/#disqus_thread"
             data-disqus-identifier="http://irlnathan.github.io/sailscasts/blog/2013/10/25/building-a-sails-application-ep25-what-is-commonjs-in-relation-to-node-what-does-it-do-how-do-i-use-it/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><iframe width="640" height="390" src="http://www.youtube.com/embed/oS01dhrjR7s" frameborder="0" allowfullscreen></iframe>


<h1>Transcript</h1>

<p>Howdy.  Today I’m here to talk about my quest to understand the mysterious world of node module dependencies. The good news is, in the end, it’s really not very mysterious.  Hopefully, by the end of this screencast I’ll have answered:</p>

<p><img class="center" src="/sailscasts/images/ep25.004.jpg"></p>

<p>Although I’ll be talking about CommonJS mainly from a node perspective this is completely relevant to sails in that you’ll be using the module pattern in your sails development.  If you’ve ever looked at the source of a node application you’ve come across some derivation of the following methods and objects.</p>

<p><img class="center" src="/sailscasts/images/ep25.005.jpg"></p>

<p>Node applications are made up of modules, which are the equivalent of source text files.  Actually that’s not completely accurate, a module can also be a compiled node module file, but I’m getting ahead of myself.  Each module or text source file is its own domain and the objects, methods, variables, and classes contained in them are oblivious to other objects, methods, variables, and classes contained in other modules.  They are in effect private to the module file that contains them.  How do we make different module files aware of each other? That’s where the module pattern comes in and specifically node’s use of CommonJS.</p>

<p><img class="center" src="/sailscasts/images/ep25.008.jpg"></p>

<p>The CommonJS implementation of the module pattern also protects the scope of your code to a particular module instead of opening up everything to a global scope. Therefore, only the modules that are connected in a way which I’m about to describe are aware of each other.</p>

<p>First a quick note on what CommonJS isn’t.  At first I got confused between RequireJS and CommonJS.  Although CommonJS does use a method named require, CommonJS and RequireJS are not the same thing.</p>

<p><img class="center" src="/sailscasts/images/ep25.010.jpg"></p>

<p>My understanding is that RequireJS was created out of a need for a module loader within the browser as opposed to node which is running on the server.  Anyway, don’t make the same mistake I did and start reading the RequireJS documentation thinking it’s the same thing as what’s used in node..</p>

<p>Now on to the module pattern. This pattern consists of two basic steps. One of the steps involves “requiring” a module you want to include from one file while from the other file or module “exposing” the stuff that you want to make available to other modules.</p>

<p><img class="center" src="/sailscasts/images/ep25.011.jpg"></p>

<p>I’m going to talk about the “require” part of pattern first. I think the best way to learn this stuff is through examples.  One of the early examples we’re exposed to in learning node is creating a server using the http module. For example:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">http</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;http&#39;</span><span class="p">);</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">server</span> <span class="o">=</span> <span class="nx">http</span><span class="p">.</span><span class="nx">createServer</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">res</span><span class="p">.</span><span class="nx">writeHead</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="p">{</span><span class="err">‘</span><span class="nx">content</span><span class="o">-</span><span class="nx">type</span><span class="err">’</span><span class="o">:</span> <span class="err">‘</span><span class="nx">text</span><span class="o">/</span><span class="nx">plain</span><span class="err">’</span><span class="p">});</span>
</span><span class='line'>  <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="err">‘</span><span class="nx">Hello</span> <span class="nx">World</span><span class="err">’</span><span class="p">);</span>
</span><span class='line'><span class="p">});</span>
</span><span class='line'><span class="nx">server</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="mi">3000</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>I want to focus on the first line: <code>var http= require(‘http’);</code>  This line creates a reference or variable to the module <code>http</code>.  This happens to be one of the modules that comes compiled with node.  Armed with our http variable we can now access everything that was exposed in that module via dot notation.  For example, that’s how access the <code>createServer</code> method.</p>

<p>However, let’s say we want to create our own module, how would we require it?  I’m going to explore several ways of requiring a module but one initial way is to use:</p>

<p><code>var utility = require('./myModule.js');</code></p>

<p>So let’s create a new file called index.js.</p>

<p>index.js</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">utility</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./myModule.js&#39;</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>&hellip;and I’ll paste our new require line into the file.  Breaking this down we have an arbitrary var named utility referencing a javascript file myModule.JS located in the same directory or relative path as index.js.  So before we starting using our new module, we need to create it.  So, next I’m going to create another file called myModule.js in the same directory with the following code.</p>

<p>myModule.js</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">balance</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">var</span> <span class="nx">addDeposit</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">amount</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="nx">amount</span> <span class="o">+</span> <span class="nx">balance</span><span class="p">;</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="p">.</span><span class="nx">balance</span> <span class="o">=</span> <span class="nx">balance</span><span class="p">;</span>
</span><span class='line'><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="p">.</span><span class="nx">addDeposit</span> <span class="o">=</span> <span class="nx">addDeposit</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>In this file I added a var called <code>balance</code> and initialized it with a value of 100. Next I created a function <code>addDeposit</code>.  The last two lines are the important part.  I exposed the var balance by exporting it via <code>module.exports</code>.  I could have named the attribute something other than balance but by convention I’m going to use the same name as the actual var.  I did the same thing to expose the addDeposit function, that is using <code>module.exports</code>.</p>

<p>Now let’s go back to our index.js file and we’ll use our newly created module.</p>

<p>index.js</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">utility</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./myModule.js&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;The current balance is: &quot;</span><span class="p">,</span> <span class="nx">utility</span><span class="p">.</span><span class="nx">balance</span><span class="p">);</span>
</span><span class='line'><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;With your deposit, your new balance is &quot;</span><span class="p">,</span> <span class="nx">utility</span><span class="p">.</span><span class="nx">addDeposit</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">+</span><span class="err">”</span><span class="p">.</span><span class="err">”</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>I can access the exported var and function from myModule through dot notation and my reference named utility.   In this case <code>utility.balance</code> for the balance and <code>utility.addDeposit(10)</code> for the function.  Again the use of the name utiityl is completely arbitrary, I could have named this reference foo. So let’s see this in action.</p>

<p>I’ll go to the terminal and type node index.js to launch our module.  And as we wanted the module returned the balance before and after the deposit.</p>

<p>Next, I’m going to expand this module to act like a class using a function as a constructor. Notice that in addition to the instance attributes and methods I also have class variables and methods (e.g. class_variable and class_method) that are not exposed via require.</p>

<p>myModule1.js</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">account</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">balance</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">class_variable</span> <span class="o">=</span> <span class="s2">&quot;Classy&quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">class_method</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>      
</span><span class='line'>    <span class="cm">/* Todo</span>
</span><span class='line'><span class="cm">     * Debit account a few cents each day and put it</span>
</span><span class='line'><span class="cm">     * Lumbergh&#39;s account</span>
</span><span class='line'><span class="cm">     */</span>
</span><span class='line'>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Nothing to see here.&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">this</span><span class="p">.</span><span class="nx">balance</span> <span class="o">=</span> <span class="nx">balance</span><span class="p">;</span>
</span><span class='line'>  <span class="k">this</span><span class="p">.</span><span class="nx">addDeposit</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">deposit</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">balance</span> <span class="o">+=</span> <span class="nx">deposit</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">account</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Keeping with the pattern after you expose or export the code you want to make available from your module, we’ll do the other step of the pattern by requiring the module. I’m creating a new file index1.js.</p>

<p>index1.js</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">Account</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./myModule1.js&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="kd">var</span> <span class="nx">account</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Account</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>
</span><span class='line'><span class="nx">account</span><span class="p">.</span><span class="nx">deposit</span> <span class="o">=</span> <span class="mi">25</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;The current balance is: &quot;</span><span class="p">,</span> <span class="nx">account</span><span class="p">.</span><span class="nx">balance</span><span class="p">);</span>
</span><span class='line'><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;With your deposit of &quot;</span> <span class="o">+</span> <span class="nx">account</span><span class="p">.</span><span class="nx">deposit</span> <span class="o">+</span> <span class="s2">&quot; your new balance is &quot;</span> <span class="o">+</span> <span class="nx">account</span><span class="p">.</span><span class="nx">addDeposit</span><span class="p">(</span><span class="nx">account</span><span class="p">.</span><span class="nx">deposit</span><span class="p">));</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here I’m instantiating the Account class reference using the var account while passing in a new balance for the account as an argument.  The other change is adding a deposit attribute to the account instance.  Now, let’s see this in action.</p>

<p>I’ll go back to the terminal and type node index1.js to launch our module.  And as we wanted the module returned the balance before and after the deposit as well as the amount of the deposit itself.</p>

<p>Next I want to show an example of the pattern where we can instantiate the Account class from within the require statement itself.</p>

<p>First, we’ll create a new module named myModule2.js.</p>

<p>myModule2.js</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">Account</span> <span class="o">=</span> <span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">balance</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="nx">obj</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">balance</span><span class="o">:</span> <span class="nx">balance</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">deposit</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">addDeposit</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">deposit</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">obj</span><span class="p">.</span><span class="nx">deposit</span> <span class="o">=</span> <span class="nx">deposit</span><span class="p">;</span>
</span><span class='line'>      <span class="k">return</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">deposit</span> <span class="o">+</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">balance</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>On line one I declare the var Account and do the export of the function in the same line of code.  I capitalized the A in Account to signify that it represents a class, however, this isn’t necessary to making any of this work and is strictly a convention.  I then build up an object that will eventually be returned when Account is instantiated.  Now let’s create index2.js:</p>

<p>index2.js</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">account</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./myModule2.js&#39;</span><span class="p">)(</span><span class="mi">2000</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="nx">account</span><span class="p">.</span><span class="nx">addDeposit</span><span class="p">(</span><span class="mi">10</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'><span class="nx">account</span><span class="p">.</span><span class="nx">deposit</span> <span class="o">=</span> <span class="mi">25</span><span class="p">;</span>
</span><span class='line'><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;The current balance is: &quot;</span><span class="p">,</span> <span class="nx">account</span><span class="p">.</span><span class="nx">balance</span><span class="p">);</span>
</span><span class='line'><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;With your deposit of &quot;</span> <span class="o">+</span> <span class="nx">account</span><span class="p">.</span><span class="nx">deposit</span> <span class="o">+</span> <span class="s2">&quot; your new balance is &quot;</span> <span class="o">+</span> <span class="nx">account</span><span class="p">.</span><span class="nx">addDeposit</span><span class="p">(</span><span class="nx">account</span><span class="p">.</span><span class="nx">deposit</span><span class="p">)</span> <span class="o">+</span> <span class="err">“</span><span class="p">.</span><span class="err">”</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>Notice in line one where we’re doing our usual require, in this case by putting the arguments on the end of the statement we’re actually creating a new instance of the Account class assigning it to account while passing the argument with a value of 2000.  Let’s see how this works.</p>

<p>The results this time reflect passing the initial balance in as an argument and we have access to our instance variables and method as expected.</p>

<p>The last example is where we export an object directly and I’m going to use our model in activityOverlord found in <code>api/models/User.js</code>.  Notice that we’re wrapping the entire file with module.exports.</p>

<p>myModule3.js</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="cm">/**</span>
</span><span class='line'><span class="cm"> * User</span>
</span><span class='line'><span class="cm"> *</span>
</span><span class='line'><span class="cm"> * @module      :: Model</span>
</span><span class='line'><span class="cm"> * @description :: A short summary of how this model works and what it represents.</span>
</span><span class='line'><span class="cm"> *</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'>
</span><span class='line'><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">schema</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">attributes</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>      
</span><span class='line'>      <span class="nx">name</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>          <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;string&#39;</span><span class="p">,</span>
</span><span class='line'>          <span class="nx">required</span><span class="o">:</span> <span class="kc">true</span>
</span><span class='line'>      <span class="p">},</span>
</span><span class='line'>
</span><span class='line'>      <span class="nx">title</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>          <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;string&#39;</span>
</span><span class='line'>      <span class="p">},</span>
</span><span class='line'>
</span><span class='line'>      <span class="nx">email</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>          <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;string&#39;</span><span class="p">,</span>
</span><span class='line'>          <span class="nx">email</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span><span class='line'>          <span class="nx">required</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span><span class='line'>          <span class="nx">unique</span><span class="o">:</span> <span class="kc">true</span>
</span><span class='line'>      <span class="p">},</span>
</span><span class='line'>
</span><span class='line'>      <span class="nx">encryptedPassword</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>          <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;string&#39;</span>
</span><span class='line'>      <span class="p">},</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">online</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;boolean&#39;</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">defaultsTo</span><span class="o">:</span> <span class="kc">false</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">admin</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;boolean&#39;</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">defaultsTo</span><span class="o">:</span> <span class="kc">false</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">toJSON</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>      <span class="kd">var</span> <span class="nx">obj</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">toObject</span><span class="p">();</span>
</span><span class='line'>      <span class="k">delete</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">password</span><span class="p">;</span>
</span><span class='line'>      <span class="k">delete</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">confirmation</span><span class="p">;</span>
</span><span class='line'>      <span class="k">delete</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">encryptedPassword</span><span class="p">;</span>
</span><span class='line'>      <span class="k">delete</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">_csrf</span><span class="p">;</span>
</span><span class='line'>      <span class="k">return</span> <span class="nx">obj</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>  <span class="nx">beforeValidation</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">values</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">values</span><span class="p">.</span><span class="nx">admin</span> <span class="o">!==</span> <span class="s1">&#39;undefined&#39;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="nx">values</span><span class="p">.</span><span class="nx">admin</span> <span class="o">===</span> <span class="s1">&#39;unchecked&#39;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">values</span><span class="p">.</span><span class="nx">admin</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span> <span class="k">else</span>  <span class="k">if</span> <span class="p">(</span><span class="nx">values</span><span class="p">.</span><span class="nx">admin</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">===</span> <span class="s1">&#39;on&#39;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">values</span><span class="p">.</span><span class="nx">admin</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>     <span class="nx">next</span><span class="p">();</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">beforeCreate</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">values</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// This checks to make sure the password and password confirmation match before creating record</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">values</span><span class="p">.</span><span class="nx">password</span> <span class="o">||</span> <span class="nx">values</span><span class="p">.</span><span class="nx">password</span> <span class="o">!=</span> <span class="nx">values</span><span class="p">.</span><span class="nx">confirmation</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="nx">next</span><span class="p">({</span><span class="nx">err</span><span class="o">:</span> <span class="p">[</span><span class="s2">&quot;Password doesn&#39;t match password confirmation.&quot;</span><span class="p">]});</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;bcrypt&#39;</span><span class="p">).</span><span class="nx">hash</span><span class="p">(</span><span class="nx">values</span><span class="p">.</span><span class="nx">password</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="kd">function</span> <span class="nx">passwordEncrypted</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">encryptedPassword</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
</span><span class='line'>      <span class="nx">values</span><span class="p">.</span><span class="nx">encryptedPassword</span> <span class="o">=</span> <span class="nx">encryptedPassword</span><span class="p">;</span>
</span><span class='line'>      <span class="c1">// values.online= true;</span>
</span><span class='line'>      <span class="nx">next</span><span class="p">();</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>Next, we’ll require this module and take a look at a couple of its attributes.</p>

<p>index3.js</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">user</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./myModule3.js&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">user</span><span class="p">.</span><span class="nx">schema</span><span class="p">);</span>
</span><span class='line'><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">user</span><span class="p">.</span><span class="nx">attributes</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>Let’s see it in action.  As expected we get back the attributes we requested via dot notation.</p>

<p>So where can I put modules?
Okay so    the last thing I want to cover is a more extensive look at where we can put modules and how to require them in these different locations.  As I mentioned at the beginning of the screencast there’s a distinction between node’s core modules and our own custom file modules we’ve been working with.  Core modules like <code>http</code> can be referenced by using just the module name (e.g. ‘http’).  For file modules we have a bunch of options.</p>

<p>So far, we’ve been accessing our modules via relative paths.  But we could also use an absolute path like:</p>

<p><code>var myModule = require(‘/home/api/foo.js’);</code></p>

<p>You can also require a file module without using ‘/’,  ‘./’ or ‘../’ however, the module must be placed in a node_modules folder. The node documentation has a good example I’ve included here.</p>

<p><img class="center" src="/sailscasts/images/ep25.016.jpg"></p>

<p>So node will first look in the same directory where the file that it’s calling is located, in this example <code>/home/ry/projects/node_modules</code>.  If it doesn’t find it there it will traverse up the file system path until it either finds the node_modules folder and module or gets to the root of the path without finding it in which case returning a ‘module not found’ error.</p>

<h2>Folders as Modules</h2>

<p>The final area I want to look at is using Folders as Modules.  This happens when you want to provide a package or library that is organized using a directory structure with one entry point to the package or library.  For example, let’s say you have a new templating library superTemp and all of its supporting modules will be installed at the root of /superTemp.</p>

<p><img class="center" src="/sailscasts/images/ep25.025.jpg"></p>

<p>You could require the library by using:</p>

<p><code>var superTemp = require(‘./superTemp’);</code></p>

<p>So what are my options for the entry point or the initial javascript file?  If I create a file index.js and put it in ‘./superTemp’, node will run that file first.  I could also use the extension index.node.  Finally, if I wanted to use a different name than index you can create a package.json file using the following syntax:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="p">{</span> <span class="s2">&quot;name&quot;</span> <span class="o">:</span> <span class="s2">&quot;superTemp&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="s2">&quot;main&quot;</span> <span class="o">:</span> <span class="s2">&quot;./superTemp/myCrazyNamingConventionDealWithIt.js&quot;</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>So let’s see how that works.  I’ve set-up an admittedly contrived directory structure under this example 1 folder.  So we have a module index.js that requires another module, myModule.js in the otherDir folder. Notice that the parenthesis at the end of the statement which means we’ll be instantiating the function.  myModule.js is a just a function that logs “Our app is launched!”.   Finally, we have a file launcher.js that requires the folder /super_temp.  So now I’ll go to the terminal and type node launcher and we get our log message that our app has launched.</p>

<p>Now let’s go into the example two folder.  Again a contrived directory structure but here instead of an index.js file we have a package.json file.  The package.json file points to <code>myCrazyNamingConventionDealWithIt.js</code> module.  And like our other example that module points to myModule in the otherDir folder.  Let’s see what happens.  And again we get the expected results.</p>

<p>Okay gang, I know that was a bunch of stuff.  I hope it was helpful and thanks for watching as always.</p>

<h2>Websites referenced</h2>

<ul>
<li><a href="http://www.commonjs.org/">CommonJS</a></li>
<li><a href="http://requirejs.org/">RequireJS</a></li>
<li><a href="http://stackoverflow.com/questions/16521471/relation-between-commonjs-amd-and-requirejs">Relation between CommonJS, AMD and RequireJS? (stackoverflow)</a></li>
<li><a href="http://nodejs.org/api/modules.html">Node Docs on Modules</a></li>
<li><a href="http://openmymind.net/2012/2/3/Node-Require-and-Exports/">Node.js, Require and Exports</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/sailscasts/blog/2013/10/21/building-a-sails-application-ep24-correcting-a-publishupdate-event-and-adding-a-policy-to-the-user-controllers-subscribe-action/">Building a Sails Application: Ep24 - Correcting a publishUpdate Event and Adding a Policy to the User Controller&#8217;s Subscribe Action</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-10-21T10:15:00-05:00" pubdate data-updated="true">Oct 21<span>st</span>, 2013</time>
        
           | <a href="/sailscasts/blog/2013/10/21/building-a-sails-application-ep24-correcting-a-publishupdate-event-and-adding-a-policy-to-the-user-controllers-subscribe-action/#disqus_thread"
             data-disqus-identifier="http://irlnathan.github.io/sailscasts/blog/2013/10/21/building-a-sails-application-ep24-correcting-a-publishupdate-event-and-adding-a-policy-to-the-user-controllers-subscribe-action/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><iframe width="640" height="390" src="http://www.youtube.com/embed/iF3y0AqDpLU" frameborder="0" allowfullscreen></iframe>


<h1>Transcript</h1>

<p>Howdy and welcome back.</p>

<p>I want to clean-up a use case that will unfortunately crash the server.  The situation occurs if a user creates an account and then while they are logged-in a different user with admin privileges deletes them from the database.  When the deleted user attempts to sign out the following server error occurs:
TypeError: Cannot read property &lsquo;name&rsquo; of undefined</p>

<p>This is because publishUpdate tries to send the user.name attribute and the user instance no longer exists.  This is an easy fix, let’s head over to the session controller.  We can wrap the userUpdate(), userPublish(), req.session.destroy(), and res.redirect() methods in an if statement that checks whether a user exists.  If the user doesn’t exist then we’ll just redirect to session/new via res.redirect(&lsquo;/session/new&rsquo;);</p>

<p>If the user does exist we’ll let just pass through to our existing logic. So now when we try to do the same use case, the browser is redirected to session/new.</p>

<p>One other change I want to make is to prevent the socket from subscribing to the user model events unless the user is authenticated.  To do this, we’ll modify the authenticated policy so that it looks for req.session.User, if it exists, the user is authenticated, and if not, we send a 403.  We’ll then use that policy in policies.js within the config folder for the subscription action of the user controller.  By doing this, the socket cannot subscribe to /user/subscribe unless the user is authenticated.  Let’s check it out.</p>

<p>So now, when the user logs in, the non-authenticated socket does not respond to the event because they are not yet authenticated and therefore not subscribed.  Once the other user logs in, however, they receive the original user’s logout event.</p>

<p>Thanks for watching.</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/sailscasts/blog/page/2/">&larr; Older</a>
    
    <a href="/sailscasts/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/sailscasts/blog/2013/11/20/sailscasts-answers-ep4-creating-a-more-attractive-url-in-sails-with-slugs-dot-dot-dot-really/">sailsCasts Answers: Ep4 - Creating a More Attractive Url in Sails With slugs&#8230;really?</a>
      </li>
    
      <li class="post">
        <a href="/sailscasts/blog/2013/11/19/sailscasts-answers-ep3-how-do-i-create-sample-dummy-users-for-my-sails-project/">sailsCasts Answers: Ep3 - How Do I Create Sample &#8216;Dummy&#8217; Users for My Sails Project?</a>
      </li>
    
      <li class="post">
        <a href="/sailscasts/blog/2013/11/05/building-a-sails-application-ep26-deploying-a-sails-app-to-heroku/">Building a Sails Application Ep26 - Deploying a Sails App to Heroku.</a>
      </li>
    
      <li class="post">
        <a href="/sailscasts/blog/2013/10/25/building-a-sails-application-ep25-what-is-commonjs-in-relation-to-node-what-does-it-do-how-do-i-use-it/">Building a Sails Application Ep25 - What Is CommonJS in Relation to Node? What Does It Do? How Do I Use It?</a>
      </li>
    
      <li class="post">
        <a href="/sailscasts/blog/2013/10/21/building-a-sails-application-ep24-correcting-a-publishupdate-event-and-adding-a-policy-to-the-user-controllers-subscribe-action/">Building a Sails Application: Ep24 - Correcting a publishUpdate Event and Adding a Policy to the User Controller&#8217;s Subscribe Action</a>
      </li>
    
  </ul>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - irl nathan -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'sailscasts';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
